<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulaire Devis avec Surface</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  label {
    display: inline-block;
    width: 120px;
    font-weight: bold;
    margin-top: 10px;
  }
  input[type="text"], input[type="date"], input[type="number"], textarea {
    padding: 5px;
    width: 200px;
  }
  textarea {
    height: 60px;
    resize: vertical;
  }
  .section-info {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 15px;
  }
  .section-info h3 {
    margin-top: 0;
  }
  .flex-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  input[type=number] {
    width: 80px;
  }
  input.surface, input.total-ligne {
    background: #eee;
    border: none;
  }
  button {
    margin-top: 10px;
    padding: 8px 15px;
    cursor: pointer;
  }
  #total-general {
    font-weight: bold;
    font-size: 1.2em;
  }
</style>
</head>
<body>

<h1>Formulaire Devis</h1>

<!-- Section Facture et Date -->
<div class="flex-row">
  <div>
    <label for="invoice-number">Numéro Devis :</label>
    <input type="text" id="invoice-number" placeholder="Ex : INV-2025-001" />
  </div>
  <div>
    <label for="date-devis">Date :</label>
    <input type="date" id="date-devis" />
  </div>
</div>

<!-- Infos Client -->
<div class="section-info">
  <h3>Informations Client</h3>
  <textarea id="info-client" placeholder="Nom, adresse, téléphone..."></textarea>
</div>

<!-- Infos Vendeur -->
<div class="section-info">
  <h3>Informations Vendeur</h3>
  <textarea id="info-vendeur" placeholder="Nom société, adresse, téléphone..."></textarea>
</div>

<!-- Tableau lignes devis -->
<table id="table-lignes">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Prix Unitaire (€)</th>
      <th>Quantité</th>
      <th>Largeur (cm)</th>
      <th>Hauteur (cm)</th>
      <th>Surface (m²)</th>
      <th>Total (€)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tbody-lignes">
    <tr class="ligne-article">
      <td><input type="text" class="designation" value="Toile PVC" /></td>
      <td><input type="number" class="prix-unitaire" value="15" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="2" min="1" step="1" /></td>
      <td><input type="number" class="largeur" value="120" min="0" step="0.01" /></td>
      <td><input type="number" class="hauteur" value="100" min="0" step="0.01" /></td>
      <td><input type="number" class="surface" value="1.20" readonly /></td>
      <td><input type="number" class="total-ligne" value="36.00" readonly /></td>
      <td><button class="btn-suppr">Supprimer</button></td>
    </tr>
  </tbody>
</table>

<button id="btn-ajouter">Ajouter une ligne</button>

<p>Total général : <span id="total-general">36.00</span> €</p>

<button id="btn-generate-pdf">Générer PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // Récupération de jsPDF
  const { jsPDF } = window.jspdf;

  function calculerSurface(largeur, hauteur) {
    return (largeur * hauteur) / 10000;
  }

  function calculerTotalLigne(surface, prixUnitaire, quantite) {
    return surface * prixUnitaire * quantite;
  }

  function mettreAJourLigne(ligne) {
    const largeur = parseFloat(ligne.querySelector('.largeur').value) || 0;
    const hauteur = parseFloat(ligne.querySelector('.hauteur').value) || 0;
    const prixUnitaire = parseFloat(ligne.querySelector('.prix-unitaire').value) || 0;
    const quantite = parseInt(ligne.querySelector('.quantite').value) || 0;

    const surface = calculerSurface(largeur, hauteur);
    ligne.querySelector('.surface').value = surface.toFixed(4);

    const total = calculerTotalLigne(surface, prixUnitaire, quantite);
    ligne.querySelector('.total-ligne').value = total.toFixed(2);
  }

  function mettreAJourTotalGeneral() {
    let totalGeneral = 0;
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      const totalLigne = parseFloat(ligne.querySelector('.total-ligne').value) || 0;
      totalGeneral += totalLigne;
    });
    document.getElementById('total-general').textContent = totalGeneral.toFixed(2);
  }

  function miseAJourComplete() {
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      mettreAJourLigne(ligne);
    });
    mettreAJourTotalGeneral();
  }

  function ajouterLigne() {
    const tbody = document.getElementById('tbody-lignes');
    const nouvelleLigne = document.createElement('tr');
    nouvelleLigne.classList.add('ligne-article');
    nouvelleLigne.innerHTML = `
      <td><input type="text" class="designation" value="" /></td>
      <td><input type="number" class="prix-unitaire" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="1" min="1" step="1" /></td>
      <td><input type="number" class="largeur" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="hauteur" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="surface" value="0.0000" readonly /></td>
      <td><input type="number" class="total-ligne" value="0.00" readonly /></td>
      <td><button class="btn-suppr">Supprimer</button></td>
    `;
    tbody.appendChild(nouvelleLigne);
  }

  function supprimerLigne(button) {
    const ligne = button.closest('tr');
    ligne.remove();
    miseAJourComplete();
  }

  document.getElementById('btn-ajouter').addEventListener('click', () => {
    ajouterLigne();
  });

  document.getElementById('tbody-lignes').addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-suppr')) {
      supprimerLigne(e.target);
    }
  });

  document.getElementById('tbody-lignes').addEventListener('input', (e) => {
    const target = e.target;
    if (['prix-unitaire', 'quantite', 'largeur', 'hauteur'].some(c => target.classList.contains(c))) {
      const ligne = target.closest('tr');
      mettreAJourLigne(ligne);
      mettreAJourTotalGeneral();
    }
  });

  // Génération PDF
  document.getElementById('btn-generate-pdf').addEventListener('click', () => {
    const doc = new jsPDF();

    // Infos facture
    const invoiceNum = document.getElementById('invoice-number').value || 'N/A';
    const dateDevis = document.getElementById('date-devis').value || 'N/A';
    const infoClient = document.getElementById('info-client').value || '';
    const infoVendeur = document.getElementById('info-vendeur').value || '';

    // Titre
    doc.setFontSize(16);
    doc.text("Devis", 105, 15, null, null, 'center');

    // Numéro et date
    doc.setFontSize(12);
    doc.text(`Numéro : ${invoiceNum}`, 14, 25);
    doc.text(`Date : ${dateDevis}`, 150, 25);

    // Infos vendeur à gauche
    doc.setFontSize(11);
    doc.text("Vendeur :", 14, 35);
    doc.setFontSize(10);
    const vendeurLines = doc.splitTextToSize(infoVendeur, 90);
    doc.text(vendeurLines, 14, 40);

    // Infos client à droite
    doc.setFontSize(11);
    doc.text("Client :", 110, 35);
    doc.setFontSize(10);
    const clientLines = doc.splitTextToSize(infoClient, 90);
    doc.text(clientLines, 110, 40);

    // Préparation tableau : on crée un tableau simplifié
    const headers = [["Désignation", "PU (€)", "Qté", "L (cm)", "H (cm)", "Surf (m²)", "Total (€)"]];
    const rows = [];

    document.querySelectorAll('.ligne-article').forEach(ligne => {
      const designation = ligne.querySelector('.designation').value || '';
      const pu = ligne.querySelector('.prix-unitaire').value || '0';
      const qte = ligne.querySelector('.quantite').value || '0';
      const l = ligne.querySelector('.largeur').value || '0';
      const h = ligne.querySelector('.hauteur').value || '0';
      const surf = ligne.querySelector('.surface').value || '0';
      const total = ligne.querySelector('.total-ligne').value || '0';

      rows.push([designation, pu, qte, l, h, surf, total]);
    });

    // On insère le tableau (avec jsPDF autotable)
    if (!doc.autoTable) {
      alert("La librairie jsPDF autotable est requise pour le tableau PDF.");
      return;
    }

    doc.autoTable({
      startY: 80,
      head: headers,
      body: rows,
      theme: 'grid',
      headStyles: {fillColor: [200, 200, 200]},
      styles: {fontSize: 9}
    });

    // Total général en bas
    const finalY = doc.lastAutoTable.finalY || 100;
    const totalGeneral = document.getElementById('total-general').textContent || '0.00';

    doc.setFontSize(12);
    doc.text(`Total général : ${totalGeneral} €`, 150, finalY + 10);

    // Enregistrement PDF
    doc.save(`Devis_${invoiceNum || 'Nouveau'}.pdf`);
  });

  // Initialisation
  miseAJourComplete();
</script>

<!-- Ajout jsPDF autotable via CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</body>
</html>
