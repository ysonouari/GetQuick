<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Devis avec Surface</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px;}
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center;}
    input[type=number] { width: 80px; }
    input[readonly] { background: #eee; }
    button { margin-top: 15px; }
  </style>
</head>
<body>

<h2>Formulaire Devis - Articles</h2>

<table id="table-devis">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Prix Unitaire (€)</th>
      <th>Quantité</th>
      <th>Largeur (cm)</th>
      <th>Hauteur (cm)</th>
      <th>Surface (m²)</th>
      <th>Total (€)</th>
    </tr>
  </thead>
  <tbody id="tbody-articles">
    <tr class="ligne-article">
      <td><input type="text" class="designation" value="Toile PVC" /></td>
      <td><input type="number" class="prix-unitaire" value="15" step="0.01" /></td>
      <td><input type="number" class="quantite" value="2" /></td>
      <td><input type="number" class="largeur" value="120" /></td>
      <td><input type="number" class="hauteur" value="100" /></td>
      <td><input type="text" class="surface" readonly /></td>
      <td><input type="text" class="total-ligne" readonly /></td>
    </tr>
  </tbody>
</table>

<button id="ajouter-ligne">Ajouter une ligne</button>
<br/>
<h3>Total devis : <span id="total-devis">0.00</span> €</h3>

<button id="generer-pdf">Générer PDF</button>

<script>
  // Calcul des surfaces et totaux ligne + total global
  function calculerSurfaceEtTotal() {
    let totalDevis = 0;
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      const largeur = parseFloat(ligne.querySelector('.largeur').value) || 0;
      const hauteur = parseFloat(ligne.querySelector('.hauteur').value) || 0;
      const surface = (largeur * hauteur) / 10000; // en m²
      ligne.querySelector('.surface').value = surface.toFixed(3);
      
      const prixUnitaire = parseFloat(ligne.querySelector('.prix-unitaire').value) || 0;
      const quantite = parseFloat(ligne.querySelector('.quantite').value) || 0;
      const totalLigne = surface * prixUnitaire * quantite;
      ligne.querySelector('.total-ligne').value = totalLigne.toFixed(2);

      totalDevis += totalLigne;
    });

    document.getElementById('total-devis').textContent = totalDevis.toFixed(2);
  }

  // Appeler la fonction au chargement et à chaque modification sur champs concernés
  function ajouterListeners() {
    document.querySelectorAll('.prix-unitaire, .quantite, .largeur, .hauteur').forEach(input => {
      input.addEventListener('input', calculerSurfaceEtTotal);
    });
  }

  // Ajout d'une nouvelle ligne vierge
  document.getElementById('ajouter-ligne').addEventListener('click', () => {
    const tbody = document.getElementById('tbody-articles');
    const tr = document.createElement('tr');
    tr.classList.add('ligne-article');
    tr.innerHTML = `
      <td><input type="text" class="designation" /></td>
      <td><input type="number" class="prix-unitaire" step="0.01" /></td>
      <td><input type="number" class="quantite" /></td>
      <td><input type="number" class="largeur" /></td>
      <td><input type="number" class="hauteur" /></td>
      <td><input type="text" class="surface" readonly /></td>
      <td><input type="text" class="total-ligne" readonly /></td>
    `;
    tbody.appendChild(tr);
    ajouterListeners();
  });

  // Génération PDF
  document.getElementById('generer-pdf').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("Devis avec Surface", 14, 22);

    // Préparer colonnes et données
    const columns = [
      { header: 'Désignation', dataKey: 'designation' },
      { header: 'Prix Unitaire (€)', dataKey: 'prixUnitaire' },
      { header: 'Quantité', dataKey: 'quantite' },
      { header: 'Largeur (cm)', dataKey: 'largeur' },
      { header: 'Hauteur (cm)', dataKey: 'hauteur' },
      { header: 'Surface (m²)', dataKey: 'surface' },
      { header: 'Total (€)', dataKey: 'total' },
    ];

    const rows = [];
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      rows.push({
        designation: ligne.querySelector('.designation').value,
        prixUnitaire: ligne.querySelector('.prix-unitaire').value,
        quantite: ligne.querySelector('.quantite').value,
        largeur: ligne.querySelector('.largeur').value,
        hauteur: ligne.querySelector('.hauteur').value,
        surface: ligne.querySelector('.surface').value,
        total: ligne.querySelector('.total-ligne').value,
      });
    });

    // Ajouter tableau au PDF
    doc.autoTable({
      startY: 30,
      head: [columns.map(col => col.header)],
      body: rows.map(row => columns.map(col => row[col.dataKey])),
    });

    // Ajouter total devis en bas
    doc.text(`Total devis : ${document.getElementById('total-devis').textContent} €`, 14, doc.lastAutoTable.finalY + 10);

    doc.save('devis.pdf');
  });

  // Initialisation
  calculerSurfaceEtTotal();
  ajouterListeners();
</script>

</body>
</html>
