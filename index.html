<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulaire Devis / Facture avec Surface</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  label {
    display: inline-block;
    width: 120px;
    font-weight: bold;
    margin-top: 10px;
  }
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    padding: 5px;
    width: 200px;
  }
  textarea {
    height: 60px;
    resize: vertical;
  }
  .section-info {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 15px;
  }
  .section-info h3 {
    margin-top: 0;
  }
  .flex-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  input[type=number] {
    width: 80px;
  }
  input.surface, input.total-ligne {
    background: #eee;
    border: none;
  }
  button {
    margin-top: 10px;
    padding: 8px 15px;
    cursor: pointer;
  }
  #total-general {
    font-weight: bold;
    font-size: 1.2em;
  }
</style>
</head>
<body>

<h1 id="titre-page">Formulaire Devis</h1>

<div class="flex-row">
  <div>
    <label for="type-document">Type :</label>
    <select id="type-document">
      <option value="devis" selected>Devis</option>
      <option value="facture">Facture</option>
    </select>
  </div>
  <div>
    <label for="invoice-number">Numéro :</label>
    <input type="text" id="invoice-number" placeholder="Ex : INV-2025-001" />
  </div>
  <div>
    <label for="date-document">Date :</label>
    <input type="date" id="date-document" />
  </div>
</div>

<div class="section-info">
  <h3>Informations Client</h3>
  <textarea id="info-client" placeholder="Nom, adresse, téléphone..."></textarea>
</div>

<div class="section-info">
  <h3>Informations Vendeur</h3>
  <textarea id="info-vendeur" placeholder="Nom société, adresse, téléphone..."></textarea>
</div>

<table id="table-lignes">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Prix Unitaire (dh)</th>
      <th>Quantité</th>
      <th>Largeur (cm)</th>
      <th>Hauteur (cm)</th>
      <th>Surface (m²)</th>
      <th>Total (dh)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tbody-lignes">
    <tr class="ligne-article">
      <td><input type="text" class="designation" value="Toile PVC" /></td>
      <td><input type="number" class="prix-unitaire" value="15" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="2" min="1" step="1" /></td>
      <td><input type="number" class="largeur" value="120" min="0" step="0.01" /></td>
      <td><input type="number" class="hauteur" value="100" min="0" step="0.01" /></td>
      <td><input type="number" class="surface" value="1.20" readonly /></td>
      <td><input type="number" class="total-ligne" value="36.00" readonly /></td>
      <td><button class="btn-suppr">Supprimer</button></td>
    </tr>
  </tbody>
</table>

<button id="btn-ajouter">Ajouter une ligne</button>

<p>Total général : <span id="total-general">36.00</span> dh</p>

<button id="btn-generate-pdf">Générer PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  const { jsPDF } = window.jspdf;

  const selectType = document.getElementById('type-document');
  const titrePage = document.getElementById('titre-page');
  selectType.addEventListener('change', () => {
    titrePage.textContent = selectType.value === 'devis' ? "Formulaire Devis" : "Formulaire Facture";
  });

  function calculerSurface(largeur, hauteur) {
    return (largeur * hauteur) / 10000;
  }

  function calculerTotalLigne(surface, prixUnitaire, quantite) {
    return surface * prixUnitaire * quantite;
  }

  function mettreAJourLigne(ligne) {
    const largeur = parseFloat(ligne.querySelector('.largeur').value) || 0;
    const hauteur = parseFloat(ligne.querySelector('.hauteur').value) || 0;
    const prixUnitaire = parseFloat(ligne.querySelector('.prix-unitaire').value) || 0;
    const quantite = parseInt(ligne.querySelector('.quantite').value) || 0;

    const surface = calculerSurface(largeur, hauteur);
    ligne.querySelector('.surface').value = surface.toFixed(4);

    const total = calculerTotalLigne(surface, prixUnitaire, quantite);
    ligne.querySelector('.total-ligne').value = total.toFixed(2);
  }

  function mettreAJourTotalGeneral() {
    let totalGeneral = 0;
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      const totalLigne = parseFloat(ligne.querySelector('.total-ligne').value) || 0;
      totalGeneral += totalLigne;
    });
    document.getElementById('total-general').textContent = totalGeneral.toFixed(2);
  }

  function miseAJourComplete() {
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      mettreAJourLigne(ligne);
    });
    mettreAJourTotalGeneral();
  }

  function ajouterLigne() {
    const tbody = document.getElementById('tbody-lignes');
    const nouvelleLigne = document.createElement('tr');
    nouvelleLigne.classList.add('ligne-article');
    nouvelleLigne.innerHTML = `
      <td><input type="text" class="designation" value="" /></td>
      <td><input type="number" class="prix-unitaire" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="1" min="1" step="1" /></td>
      <td><input type="number" class="largeur" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="hauteur" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="surface" value="0.0000" readonly /></td>
      <td><input type="number" class="total-ligne" value="0.00" readonly /></td>
      <td><button class="btn-suppr">Supprimer</button></td>
    `;
    tbody.appendChild(nouvelleLigne);
  }

  function supprimerLigne(button) {
    const ligne = button.closest('tr');
    ligne.remove();
    miseAJourComplete();
  }

  document.getElementById('btn-ajouter').addEventListener('click', () => {
    ajouterLigne();
  });

  document.getElementById('tbody-lignes').addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-suppr')) {
      supprimerLigne(e.target);
    }
  });

  document.getElementById('tbody-lignes').addEventListener('input', (e) => {
    const target = e.target;
    if (['prix-unitaire', 'quantite', 'largeur', 'hauteur'].some(c => target.classList.contains(c))) {
      const ligne = target.closest('tr');
      mettreAJourLigne(ligne);
      mettreAJourTotalGeneral();
    }
  });

  document.getElementById('btn-generate-pdf').addEventListener('click', () => {
    const doc = new jsPDF();

    const typeDoc = selectType.value === 'devis' ? "Devis" : "Facture";
    const invoiceNum = document.getElementById('invoice-number').value || 'N/A';
    const dateDoc = document.getElementById('date-document').value || 'N/A';
    const infoClient = document.getElementById('info-client').value || '';
    const infoVendeur = document.getElementById('info-vendeur').value || '';

    doc.setFontSize(16);
    doc.text(typeDoc, 105, 15, null, null, 'center');

    doc.setFontSize(12);
    doc.text(`Numéro : ${invoiceNum}`, 14, 25);
    doc.text(`Date : ${dateDoc}`, 150, 25);

    doc.text("Vendeur :", 14, 35);
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(infoVendeur, 80), 14, 40);

    doc.setFontSize(12);
    doc.text("Client :", 130, 35);
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(infoClient, 80), 130, 40);

    const rows = [];
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      rows.push([
        ligne.querySelector('.designation').value,
        ligne.querySelector('.prix-unitaire').value,
        ligne.querySelector('.quantite').value,
        ligne.querySelector('.largeur').value,
        ligne.querySelector('.hauteur').value,
        ligne.querySelector('.surface').value,
        ligne.querySelector('.total-ligne').value,
      ]);
    });

    doc.autoTable({
      start
Y: 80,
head: [['Désignation', 'PU (dh)', 'Qté', 'Larg (cm)', 'Haut (cm)', 'Surface (m²)', 'Total (dh)']],
body: rows,
theme: 'grid',
});
const finalY = doc.lastAutoTable.finalY || 80;

const totalGeneral = document.getElementById('total-general').textContent;
doc.setFontSize(12);
doc.text(`Total général : ${totalGeneral} dh`, 14, finalY + 10);

doc.save(`${typeDoc}_${invoiceNum}.pdf`);
});

miseAJourComplete();
</script>

</body> </html> ```
