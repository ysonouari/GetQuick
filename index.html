<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulaire Devis / Facture Professionnel</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

  body {
    font-family: 'Inter', sans-serif;
    background: #f8f9fa;
    color: #343a40;
    margin: 30px auto;
    max-width: 900px;
    padding: 0 15px 40px;
  }

  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 25px;
    user-select: none;
  }

  .flex-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 25px;
  }

  .flex-row > div {
    flex: 1;
    min-width: 220px;
  }

  label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
    color: #495057;
  }

  input[type="text"],
  input[type="date"],
  input[type="number"],
  textarea,
  select {
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 8px 10px;
    width: 100%;
    font-size: 0.95rem;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }

  input[type="text"]:focus,
  input[type="date"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    border-color: #3b82f6;
    outline: none;
    box-shadow: 0 0 6px #3b82f6aa;
  }

  textarea {
    height: 60px;
    resize: vertical;
  }

  .section-info {
    background: #ffffff;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 25px;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
  }

  .section-info h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
    user-select: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
    margin-bottom: 25px;
  }

  th, td {
    padding: 12px 15px;
    text-align: center;
    font-size: 0.9rem;
  }

  th {
    background-color: #3b82f6;
    color: white;
    font-weight: 700;
  }

  tbody tr:nth-child(even) {
    background-color: #f1f5f9;
  }

  tbody tr:hover {
    background-color: #dbeafe;
  }

  input.surface,
  input.total-ligne {
    background: #e9ecef;
    border: none;
    pointer-events: none;
  }

  button {
    background-color: #3b82f6;
    border: none;
    padding: 10px 18px;
    color: white;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }

  button:hover {
    background-color: #2563eb;
  }

  .btn-suppr {
    background-color: #ef4444;
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 5px;
  }

  .btn-suppr:hover {
    background-color: #b91c1c;
  }

  #logo-preview {
    max-height: 100px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    object-fit: contain;
    display: block;
    user-select: none;
  }

  #total-general {
    font-weight: 700;
    font-size: 1.3rem;
    color: #1e293b;
    user-select: none;
  }

  .bottom-buttons {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .flex-row {
      flex-direction: column;
    }
    .bottom-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<h1 id="titre-page">Formulaire Devis</h1>

<div class="flex-row">
  <div>
    <label for="type-document">Type :</label>
    <select id="type-document">
      <option value="devis" selected>Devis</option>
      <option value="facture">Facture</option>
    </select>
  </div>
  <div>
    <label for="invoice-number">Numéro :</label>
    <input type="text" id="invoice-number" placeholder="Ex : INV-2025-001" />
  </div>
  <div>
    <label for="date-document">Date :</label>
    <input type="date" id="date-document" />
  </div>
</div>

<div class="section-info">
  <h3>Informations Vendeur</h3>
  <textarea id="info-vendeur" placeholder="Nom société, adresse, téléphone..."></textarea>
</div>

<div class="section-info">
  <h3>Informations Client</h3>
  <textarea id="info-client" placeholder="Nom, adresse, téléphone..."></textarea>
</div>

<div class="section-info">
  <h3>Logo (optionnel)</h3>
  <input type="file" id="logo-upload" accept="image/*" />
  <img id="logo-preview" alt="Aperçu logo" style="display:none" />
</div>

<div class="section-info">
  <h3>TVA (%)</h3>
  <input type="number" id="tva" value="20" min="0" max="100" step="0.01" />
</div>

<table id="table-lignes">
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Prix Unitaire (dh)</th>
      <th>Quantité</th>
      <th>Largeur (cm)</th>
      <th>Hauteur (cm)</th>
      <th>Surface (m²)</th>
      <th>Total (dh)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tbody-lignes">
    <tr class="ligne-article">
      <td><input type="text" class="designation" value="Toile PVC" /></td>
      <td><input type="number" class="prix-unitaire" value="15" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="2" min="1" step="1" /></td>
      <td><input type="number" class="largeur" value="120" min="0" step="0.01" /></td>
      <td><input type="number" class="hauteur" value="100" min="0" step="0.01" /></td>
      <td><input type="number" class="surface" value="1.20" readonly /></td>
      <td><input type="number" class="total-ligne" value="36.00" readonly /></td>
      <td><button class="btn-suppr">Supprimer</button></td>
    </tr>
  </tbody>
</table>

<div class="flex-row" style="justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 25px;">
  <div>
    <strong>Total HT :</strong> <span id="total-ht">0.00</span> dh
  </div>
  <div>
    <strong>TVA (<span id="tva-percent">20</span>%) :</strong> <span id="total-tva">0.00</span> dh
  </div>
  <div>
    <strong>Total TTC :</strong> <span id="total-ttc" style="color:#2563eb; font-weight:700;">0.00</span> dh
  </div>
</div>

<div class="bottom-buttons">
  <button id="btn-ajouter">Ajouter une ligne</button>
  <button id="btn-nouvelle-facture" style="background:#6b7280;">Nouvelle facture</button>
  <button id="btn-generate-pdf">Générer PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  const { jsPDF } = window.jspdf;

  const selectType = document.getElementById('type-document');
  const titrePage = document.getElementById('titre-page');
  const tbodyLignes = document.getElementById('tbody-lignes');
  const tvaInput = document.getElementById('tva');
  const tvaPercentDisplay = document.getElementById('tva-percent');
  const totalHTSpan = document.getElementById('total-ht');
  const totalTVASpan = document.getElementById('total-tva');
  const totalTTCSpan = document.getElementById('total-ttc');
  const logoUpload = document.getElementById('logo-upload');
  const logoPreview = document.getElementById('logo-preview');

  // Changer le titre selon type document
  selectType.addEventListener('change', () => {
    titrePage.textContent = selectType.value === 'devis' ? "Formulaire Devis" : "Formulaire Facture";
  });

  // Afficher aperçu logo uploadé
  logoUpload.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) {
      logoPreview.style.display = 'none';
      logoPreview.src = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(event) {
      logoPreview.src = event.target.result;
      logoPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // Calcul surface en m²
  function calculerSurface(largeur, hauteur) {
    return (largeur * hauteur) / 10000;
  }

  // Calcul total ligne (surface * PU * qt)
  function calculerTotalLigne(surface, prixUnitaire, quantite) {
    return surface * prixUnitaire * quantite;
  }

  // Met à jour une ligne donnée
  function mettreAJourLigne(ligne) {
    const largeur = parseFloat(ligne.querySelector('.largeur').value) || 0;
    const hauteur = parseFloat(ligne.querySelector('.hauteur').value) || 0;
    const prixUnitaire = parseFloat(ligne.querySelector('.prix-unitaire').value) || 0;
    const quantite = parseInt(ligne.querySelector('.quantite').value) || 0;

    const surface = calculerSurface(largeur, hauteur);
    ligne.querySelector('.surface').value = surface.toFixed(4);

    const total = calculerTotalLigne(surface, prixUnitaire, quantite);
    ligne.querySelector('.total-ligne').value = total.toFixed(2);
  }

  // Met à jour tous les totaux HT, TVA et TTC
  function mettreAJourTotaux() {
    let totalHT = 0;
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      const totalLigne = parseFloat(ligne.querySelector('.total-ligne').value) || 0;
      totalHT += totalLigne;
    });

    totalHTSpan.textContent = totalHT.toFixed(2);

    const tvaPct = parseFloat(tvaInput.value) || 0;
    tvaPercentDisplay.textContent = tvaPct.toFixed(2);

    const totalTVA = totalHT * (tvaPct / 100);
    totalTVASpan.textContent = totalTVA.toFixed(2);

    const totalTTC = totalHT + totalTVA;
    totalTTCSpan.textContent = totalTTC.toFixed(2);
  }

  // Mise à jour complète
  function miseAJourComplete() {
    document.querySelectorAll('.ligne-article').forEach(ligne => {
      mettreAJourLigne(ligne);
    });
    mettreAJourTotaux();
  }

  // Ajouter une nouvelle ligne
  function ajouterLigne() {
    const nouvelleLigne = document.createElement('tr');
    nouvelleLigne.classList.add('ligne-article');
    nouvelleLigne.innerHTML = `
      <td><input type="text" class="designation" value="" placeholder="Produit / service" /></td>
      <td><input type="number" class="prix-unitaire" value="0" min="0" step="0.01" /></td>
      <td><input type="number" class="quantite" value="1" min="1" step="1" /></td>
      <
td><input type="number" class="largeur" value="0" min="0" step="0.01" /></td>
<td><input type="number" class="hauteur" value="0" min="0" step="0.01" /></td>
<td><input type="number" class="surface" value="0" readonly /></td>
<td><input type="number" class="total-ligne" value="0" readonly /></td>
<td><button class="btn-suppr">Supprimer</button></td>
`;
tbodyLignes.appendChild(nouvelleLigne);
ajouterListenersLigne(nouvelleLigne);
}

// Supprimer ligne
tbodyLignes.addEventListener('click', (e) => {
if (e.target.classList.contains('btn-suppr')) {
e.target.closest('tr').remove();
miseAJourComplete();
}
});

// Ajouter listeners sur une ligne
function ajouterListenersLigne(ligne) {
['prix-unitaire', 'quantite', 'largeur', 'hauteur'].forEach(cls => {
ligne.querySelector('.' + cls).addEventListener('input', () => {
mettreAJourLigne(ligne);
mettreAJourTotaux();
});
});
}

// Initialisation
document.querySelectorAll('.ligne-article').forEach(ligne => {
ajouterListenersLigne(ligne);
});

// Mettre à jour quand TVA change
tvaInput.addEventListener('input', () => {
mettreAJourTotaux();
});

// Bouton ajouter ligne
document.getElementById('btn-ajouter').addEventListener('click', () => {
ajouterLigne();
});

// Bouton nouvelle facture (reset tout)
document.getElementById('btn-nouvelle-facture').addEventListener('click', () => {
if (!confirm('Voulez-vous vraiment créer une nouvelle facture ? Les données actuelles seront perdues.')) return;
  // Reset champs principaux
selectType.value = 'devis';
titrePage.textContent = 'Formulaire Devis';
document.getElementById('invoice-number').value = '';
document.getElementById('date-document').value = '';
document.getElementById('info-vendeur').value = '';
document.getElementById('info-client').value = '';
tvaInput.value = 20;
tvaPercentDisplay.textContent = '20';

// Reset logo
logoUpload.value = '';
logoPreview.style.display = 'none';
logoPreview.src = '';

// Reset lignes
tbodyLignes.innerHTML = '';
ajouterLigne();

miseAJourTotaux();
});

// Fonction génération PDF
document.getElementById('btn-generate-pdf').addEventListener('click', () => {
const doc = new jsPDF();
  // Logo
if (logoPreview.src && logoPreview.style.display !== 'none') {
  const imgWidth = 50;
  const imgHeight = (logoPreview.naturalHeight / logoPreview.naturalWidth) * imgWidth;
  doc.addImage(logoPreview.src, 'PNG', 15, 10, imgWidth, imgHeight);
}

// Titre
doc.setFontSize(22);
doc.setTextColor('#2563eb');
doc.text(selectType.value === 'devis' ? 'DEVIS' : 'FACTURE', 150, 20, { align: 'right' });

// Infos facturation
doc.setFontSize(11);
doc.setTextColor('#000000');
doc.text(`N°: ${document.getElementById('invoice-number').value}`, 150, 30, { align: 'right' });
doc.text(`Date: ${document.getElementById('date-document').value}`, 150, 36, { align: 'right' });

// Infos vendeur
doc.setFontSize(12);
doc.setTextColor('#2c3e50');
doc.text('Vendeur :', 15, 40);
let vendeur = document.getElementById('info-vendeur').value.trim();
vendeur.split('\n').forEach((line, i) => {
  doc.text(line, 15, 46 + i * 6);
});

// Infos client
doc.text('Client :', 110, 40);
let client = document.getElementById('info-client').value.trim();
client.split('\n').forEach((line, i) => {
  doc.text(line, 110, 46 + i * 6);
});

// Table des lignes
const lignes = [];
document.querySelectorAll('.ligne-article').forEach(ligne => {
  const designation = ligne.querySelector('.designation').value;
  const pu = ligne.querySelector('.prix-unitaire').value;
  const quantite = ligne.querySelector('.quantite').value;
  const largeur = ligne.querySelector('.largeur').value;
  const hauteur = ligne.querySelector('.hauteur').value;
  const surface = ligne.querySelector('.surface').value;
  const totalLigne = ligne.querySelector('.total-ligne').value;

  lignes.push([
    designation,
    pu + ' dh',
    quantite,
    largeur + ' cm',
    hauteur + ' cm',
    surface + ' m²',
    totalLigne + ' dh',
  ]);
});

doc.autoTable({
  startY: 85,
  head: [['Désignation', 'PU', 'Qté', 'Larg.', 'Haut.', 'Surface', 'Total']],
  body: lignes,
  styles: { halign: 'center' },
  headStyles: { fillColor: '#3b82f6', textColor: 255 },
  columnStyles: {
    0: { halign: 'left', cellWidth: 45 },
    1: { cellWidth: 18 },
    2: { cellWidth: 15 },
    3: { cellWidth: 18 },
    4: { cellWidth: 18 },
    5: { cellWidth: 25 },
    6: { cellWidth: 25 },
  },
});

// Totaux en bas
const finalY = doc.lastAutoTable.finalY + 10;

const totalHT = parseFloat(totalHTSpan.textContent);
const totalTVA = parseFloat(totalTVASpan.textContent);
const totalTTC = parseFloat(totalTTCSpan.textContent);
const tvaPct = parseFloat(tvaInput.value);

doc.setFontSize(12);
doc.text(`Total HT : ${totalHT.toFixed(2)} dh`, 140, finalY);
doc.text(`TVA (${tvaPct.toFixed(2)}%) : ${totalTVA.toFixed(2)} dh`, 140, finalY + 7);
doc.setTextColor('#2563eb');
doc.setFontSize(14);
doc.text(`Total TTC : ${totalTTC.toFixed(2)} dh`, 140, finalY + 15);
doc.setTextColor('#000000');

// Exporter le PDF
doc.save(`${selectType.value}_${document.getElementById('invoice-number').value || 'sans_numero'}.pdf`);
});

// Initial calcul
miseAJourComplete();
</script>

</body> </html> ```
